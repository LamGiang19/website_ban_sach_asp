@model List<WebBanSachLg.Database.DonHang>
@{
    ViewData["Title"] = "Lịch sử đơn hàng - Vua Sách Cũ";
}

<div class="container mt-4">
    <h2><i class="fas fa-history"></i> Lịch sử đơn hàng</h2>

    @if (Model != null && Model.Any())
    {
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Mã đơn hàng</th>
                        <th>Ngày đặt</th>
                        <th>Tổng tiền</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var donHang in Model)
                    {
                        <tr>
                            <td>#@donHang.Id</td>
                            <td>@donHang.NgayDat?.ToString("dd/MM/yyyy HH:mm")</td>
                            <td>@donHang.TongTien.ToString("N0")₫</td>
                            <td>
                                @switch (donHang.TrangThai)
                                {
                                    case "Chờ xử lý":
                                        <span class="badge bg-warning">@donHang.TrangThai</span>
                                        break;
                                    case "Đang giao":
                                        <span class="badge bg-info">@donHang.TrangThai</span>
                                        break;
                                    case "Đã giao":
                                        <span class="badge bg-success">@donHang.TrangThai</span>
                                        break;
                                    case "Đã hủy":
                                        <span class="badge bg-danger">@donHang.TrangThai</span>
                                        break;
                                    default:
                                        <span class="badge bg-secondary">@donHang.TrangThai</span>
                                        break;
                                }
                            </td>
                            <td>
                                <a asp-action="Details" asp-route-id="@donHang.Id" class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i> Chi tiết
                                </a>
                                @if (donHang.TrangThai == "Chờ xử lý")
                                {
                                    <button class="btn btn-sm btn-danger btn-cancel-order" data-id="@donHang.Id">
                                        <i class="fas fa-times"></i> Hủy
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="alert alert-info text-center">
            <i class="fas fa-shopping-bag fa-3x mb-3"></i>
            <p>Bạn chưa có đơn hàng nào</p>
            <a asp-controller="Sach" asp-action="Index" class="btn btn-orange">
                <i class="fas fa-shopping-bag"></i> Mua sắm ngay
            </a>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('.btn-cancel-order').click(function() {
                var orderId = $(this).data('id');
                
                showConfirm(
                    'Bạn có chắc muốn hủy đơn hàng này?',
                    function() {
                        $.ajax({
                            url: '@Url.Action("Cancel", "DonHang")',
                            type: 'POST',
                            data: { id: orderId },
                            success: function(response) {
                                if (response.success) {
                                    showSuccess(response.message || 'Đã hủy đơn hàng thành công');
                                    setTimeout(function() {
                                        location.reload();
                                    }, 1500);
                                } else {
                                    showError(response.message || 'Có lỗi xảy ra');
                                }
                            },
                            error: function() {
                                showError('Có lỗi xảy ra. Vui lòng thử lại.');
                            }
                        });
                    }
                );
            });
        });
    </script>
}

